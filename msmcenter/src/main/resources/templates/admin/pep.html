<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <link href='/css/fullcalendar.min.css' rel='stylesheet' />
    <link href='/css/fullcalendar.print.min.css' rel='stylesheet' media='print' />
    <script src='/js/moment.min.js'></script>
    <script src='/js/jquery.min.js'></script>
    <script src='/js/fullcalendar.min.js'></script>
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="/fonts/ionicons.min.css">
    <link rel="stylesheet" href="/css/Data-Table-1.css">
    <link rel="stylesheet" href="/css/Data-Table.css">
    <link rel="stylesheet" href="/css/Footer-Dark-1.css">
    <link rel="stylesheet" href="/css/Footer-Dark.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" href="/css/Navigation-Clean.css">
    <link rel="stylesheet" href="/css/Google-Style-Login.css">
    <link rel="stylesheet" href="/css/Pretty-Table-1.css">
    <link rel="stylesheet" href="/css/Pretty-Table.css">
    <link rel="stylesheet" href="/css/Profile-Edit-Form-1.css">
    <link rel="stylesheet" href="/css/Profile-Edit-Form.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/bootstrap-datepicker-1/css/bootstrap-datepicker3.css">
    <script src="/bootstrap-datepicker-1/js/bootstrap-datepicker.js"></script>
    <button ></button>
</head>

<body>
<div th:replace="/../fragments/adminHeader ::navbar" name="header"></div>
<div class="container" style="margin-top: 10%">

    <table id="infotable" class="table table-bordered table-striped table-dark" style="margin-bottom: 5%;width: 150px;height:300px;">
        <tbody>
            <tr>
                <th>Zuletzt bearbeite am</th>
                <td ></td>
            </tr>
            <tr>
                <th>Auftraggeber</th>
                <td id="rechnungskunde">test</td>
            </tr>
            <tr>
                <th>Kunde</th>
                <td id="leistungskunde">test</td>
            </tr>
            <tr>
                <th>Standort</th>
                <td id="ort">test</td>
            </tr>
            <tr>
                <th>Monat</th>
                <td id="monat"></td>
            </tr>
            <tr>
                <th>Jahr</th>
                <td id="jahr"></td>
            </tr>
            <tr>
                <th>Flächen-nr</th>
                <td id="fläche"></td>
            </tr>
            <tr>
                <th>Flächenbetreuung</th>
                <td></td>
            </tr>

        </tbody>
    </table>
<table id="datatable" class="table table-striped">
    <thead>

    <tr>
        <td align="left"><a href='javascript:prevMonth()'><i class="fa fa-chevron-left" style="margin: 0px 10px 0px;"></i></a></td>
        <td colspan=3 class='calendar_head_month' id='calendar_month'>
            </td>
        <td><a href='javascript:today()' >Aktueller Monat</a></td>
        <td colspan=3 class='calendar_head_month' id='calendar_month2'>
        </td>
        <td align="right" ><a href='javascript:nextMonth()'><i class="fa fa-chevron-right" style="margin: 0px 10px 0px;"></i></a></td>
    </tr>
    <tr>
        <th scope="col">Datum</th>
        <th scope="col">Wochentag</th>
        <th scope="col">Einsatzkraft</th>
        <th scope="col">Beginn (Uhrzeit)</th>
        <th scope="col">Ende (Uhrzeit)</th>
        <th scope="col">Pause(in Std)</th>
        <th scope="col">Arbeitszeit</th>
        <th scope="col">Bemerkung</th>
        <th scope="col">Besetzung hinzufügen</th>
    </tr>
    </thead>
    <tbody>

    </tbody>
</table>
</div>
<script>
    var button = "<button class=\"btn btn-primary\" type=\"button\" data-toggle=\"modal\" data-target=\"#myModal\">Hinzufügen</button>\n" +
        "<div role=\"dialog\" tabindex=\"-1\" class=\"modal fade\" id=\"myModal\">\n" +
        "    <div class=\"modal-dialog\" role=\"document\">\n" +
        "        <div class=\"modal-content\">\n" +
        "            <div class=\"modal-header\">\n" +
        "                <h4 class=\"modal-title\">Besetzung hinzufügen</h4>\n" +
        "                <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Schließen\">\n" +
        "                    <span aria-hidden=\"true\">×</span>\n" +
        "                </button>\n" +
        "            </div>\n" +
        "            <div class=\"modal-body\">\n" +
        "                <form>\n" +
        "                    <label>Flächen-ID</label>\n" +
        "                    <input class=\"form-control\"  type=\"text\">\n" +
        "                    <label>Einsatzkraft ID</label>\n" +
        "                    <input class=\"form-control\" type=\"text\">\n" +
        "                    <label>Datum</label>\n" +
        "                    <input type=\"text\" class=\"form-control\">\n" +
        "                    <label>LK-Ansprechpartner</label>\n" +
        "                    <input class=\"form-control\"  type=\"text\">\n" +
        "                    <label>Start</label>\n" +
        "                    <input class=\"form-control\" type=\"text\">\n" +
        "                    <label>Ende</label>\n" +
        "                    <input class=\"form-control\" type=\"text\">\n" +
        "                </form>\n" +
        "            </div>\n" +
        "            <div class=\"modal-footer\"><button class=\"btn btn-light\" type=\"button\" data-dismiss=\"modal\">Schließen</button><button class=\"btn btn-primary\" type=\"button\">Speichern</button></div>\n" +
        "        </div>\n" +
        "    </div>\n" +
        "</div>"

    var days = [];
    var events = [];
    var dates = [];
    var currentDate = new Date();
    var currentMonth = currentDate.getMonth();
    var currentYeahr = currentDate.getFullYear();
    datatable = document.getElementById("datatable");
    getEvents();
    initalize();
    var url_string = window.location.href;//window.location.href
    console.log(window.location.href);
    var url = new URL(url_string);
    var c = url.searchParams.get("c");
    console.log(c);
    function initalize() {
        clearCalender();
        dates = [];
        var date = new Date(currentYeahr,currentMonth,1);
        while (date.getMonth() === currentMonth) {
            dates.push(new Date(date));
            var tag = date.getDate() +"."+(date.getMonth()+1)+"."+date.getFullYear();
            var alles = [button,"","","","","","",getDayOfWeek(date),tag];
            days.push(alles);
            date.setDate(date.getDate() + 1);
        }
        console.log(events);
        datatable = document.getElementById("datatable");
        loadCalender();
    }

    function today(){
        clearCalender();
        var today = new Date();
        currentMonth = today.getMonth();
        currentYeahr = today.getFullYear();
        var date = new Date(currentYeahr,currentMonth,1);
        while (date.getMonth() === currentMonth) {
            dates.push(new Date(date));
            var tag = date.getDate() +"."+(currentMonth+1)+"."+date.getFullYear();
            var alles = [button,"","","","","","",getDayOfWeek(date),tag];
            days.push(alles);
            date.setDate(date.getDate() + 1);
        }
        datatable = document.getElementById("datatable");
        loadCalender();
    }

    function prevMonth(){
        clearCalender()
        if(currentMonth-1<0){
            currentMonth = 11;
            currentYeahr = currentYeahr-1;
        } else {
            currentMonth = currentMonth-1;
        }
        var date = new Date(currentYeahr,currentMonth,1);
        while (date.getMonth() === currentMonth) {
            dates.push(new Date(date));
            var tag = date.getDate() +"."+(currentMonth+1)+"."+date.getFullYear();
            var alles = [button,"","","","","","",getDayOfWeek(date),tag];
            days.push(alles);
            date.setDate(date.getDate() + 1);
        }
        datatable = document.getElementById("datatable");
        loadCalender();
    }
    function nextMonth(){
        clearCalender()
        if(currentMonth+2>12){
            currentMonth = 0;
            currentYeahr = currentYeahr+1;
        } else {
            currentMonth = currentMonth+1;
        }
        var date = new Date(currentYeahr,currentMonth,1);
        while (date.getMonth() === currentMonth) {
            var tag = date.getDate() +"."+(currentMonth+1)+"."+date.getFullYear();
            var alles = [button,"","","","","","",getDayOfWeek(date),tag];
            days.push(alles);
            dates.push(new Date(date));
            date.setDate(date.getDate() + 1);

        }
        datatable = document.getElementById("datatable");
        console.log(dates);
        loadCalender();
    }

    function clearCalender(){
        days = [];
        dates = [];
        var myTable = document.getElementById("datatable");
        var rowCount = myTable.rows.length;
        for (var x=rowCount-1;x>1; x--) {
            myTable.deleteRow(x);
        }
    }

    function getEvents(){
        var request = new XMLHttpRequest();
        request.open('GET', '/admin/kalender/events?yeahr='+currentYeahr+"&month="+currentMonth, true);
        request.onload = function () {
            if (request.status >= 200 && request.status < 400) {
                events = [];
                events = JSON.parse(this.response);
                console.log(events);
            } else {
                console.log('error');
            }
        }
        request.send();

    }

    //Schreibt die Tage/Monate/Jahre und andere Daten in die Tabelle
    function loadCalender(){
        insertEvents();
        getRechnungskundeInformation();
        var monat = document.getElementById("monat");
        monat.innerHTML = getNameOfMonth(currentMonth);
        var jahr = document.getElementById("jahr");
        jahr.innerHTML = currentYeahr;
        for(var i = 0; i < days.length; i++)
        {
            // create a new row
            var newRow = datatable.insertRow(datatable.length);
            for(var j = 0; j < days[i].length; j++)
            {
                // create a new cell
                var cell = newRow.insertCell(0);
                // add value to the cell
                cell.innerHTML = days[i][j];
            }
        }
    }

    //Schreibt in das Day Array die Events für eine Flaeche
    function insertEvents(){
        for(var i = 0; i<events.length;i++) {
            for(var j = 0;j<dates.length;j++) {
                var acevent = events[i].start;
                var acdate = acevent.substr(0, acevent.length-5);
                var newdate = new Date(acdate);
                if(sameDate(newdate,dates[j])) {
                    if(days[j][4]!== ""){
                        days.splice(j,0,days[j])
                        replace(i,j+1,events[i].einsatzkraft)
                    } else {
                        replace(i,j,events[i].einsatzkraft);

                    }
                }
            }
        }
    }
    //tauscht zwei daten miteinander aus
    function replace(stelledaten,stellearray,einsatzkraft){
        events[stelledaten]
        days[stellearray]
        var array = [];
        for(var i = 0;i<days[stellearray].length;i++){
            array.push(days[stellearray][i]);
        }
        var acevent = events[stelledaten].start;
        var acdate = acevent.substr(0, acevent.length-5);
        var newdate = new Date(acdate);
        var acevent2 = events[stelledaten].end;
        var acdate2 = acevent2.substr(0, acevent.length-5);
        var newdate2 = new Date(acdate2);
        array[6] = einsatzkraft.vorname + " " + einsatzkraft.name;
        array[3] = "0.5";
        array[4] = newdate.getHours();
        array[5] = newdate2.getHours();
        var x = parseFloat(array[3]);
        console.log(x);
        array[2] =  newdate.getHours()-newdate2.getHours()-x;
        days[stellearray] = array;
    }
    //gibt die RechnungskundenInformation an die Tabelle aus
    function getRechnungskundeInformation() {
        var request = new XMLHttpRequest();
        request.open('GET', '/admin/kalender/fläche', true);
        request.onload = function () {
            if (request.status >= 200 && request.status < 400) {
                var flächeData = JSON.parse(this.response);
                var fläche = document.getElementById("fläche");
                fläche.innerHTML = flächeData.id;
                var rechnungsKunde = document.getElementById("rechnungskunde")
                rechnungsKunde.innerHTML = flächeData.rechnungskundeDifferenzierung.rechnungskunde.name;
                var leistungskunde = document.getElementById("leistungskunde")
                leistungskunde.innerHTML = flächeData.leistungskunde.name;
                var ort = document.getElementById("ort");
                ort.innerHTML = flächeData.leistungskunde.ort;
            } else {
                console.log('error');
            }
        }
        request.send();
    }
    //Schreibt Zahlen in Monate um
    function getNameOfMonth(date){
        var months    = ['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
        return months[date];
    }

    //Schreibt Zahlen in Wochentage um
    function getDayOfWeek(date) {
        var dayOfWeek = new Date(date).getDay();
        return isNaN(dayOfWeek) ? null : ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'][dayOfWeek];
    }

    //Überprüft ob zwei Daten gleich sind
    function sameDate(date1, date2) {
        return date1.getDate() == date2.getDate() &&
            date1.getMonth() == date2.getMonth() &&
            date1.getFullYear() == date2.getFullYear();
    }


</script>
<button class="btn btn-primary" type="button" data-toggle="modal" data-target="#myModal" hidden>Hinzufügen</button>
<div role="dialog" tabindex="-1" class="modal fade" id="myModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Besetzung hinzufügen</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Schließen">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <label>Flächen-ID</label>
                    <input class="form-control" type="text">
                    <label>Einsatzkraft ID</label>
                    <input class="form-control" type="text">
                    <label>Datum</label>
                    <input type="text" class="form-control">
                    <label>LK-Ansprechpartner</label>
                    <input class="form-control" type="text">
                    <label>Start</label>
                    <input class="form-control" type="text">
                    <label>Ende</label>
                    <input class="form-control" type="text">
                    <div class="container">
                        <div class="row">
                            <div class='col-sm-6'>
                                <div class="form-group">
                                    <div class='input-group date' id='datetimepicker1'>
                                        <input type='text' class="form-control" />
                                        <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-light" type="button" data-dismiss="modal">Schließen</button><button class="btn btn-primary" type="button">Speichern</button></div>
        </div>
    </div>
</div>
<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.15/js/dataTables.bootstrap.min.js"></script>
<script src="/js/Profile-Edit-Form.js"></script>
</body>
</html>