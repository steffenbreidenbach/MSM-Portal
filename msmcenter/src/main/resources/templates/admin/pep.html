<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <script src='/js/moment.min.js'></script>
    <script src='/js/jquery.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/css/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="/fonts/ionicons.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.15/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" href="/css/Navigation-Clean.css">
    <link rel="stylesheet" href="/css/Google-Style-Login.css">
    <link rel="stylesheet" href="/css/Pretty-Table-1.css">
    <link rel="stylesheet" href="/css/Pretty-Table.css">
    <link rel="stylesheet" href="/css/Profile-Edit-Form-1.css">
    <link rel="stylesheet" href="/css/Profile-Edit-Form.css">
    <link rel="stylesheet" href="/css/styles.css">
    <!-- -->
    <!-- DataTables Select CSS -->
    <link href="css/addons/datatables-select.min.css" rel="stylesheet">
    <!-- DataTables Select CSS -->
    <script href="css/addons/datatables-select.min.js" rel="stylesheet"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/2.14.1/moment.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/css/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="/js/locale/de.js"></script>
    <script>
        $(function () {
                $('#datetimepicker6').datetimepicker({
                    format: 'LT',
                    locale : 'de'
                });
                $('#datetimepicker7').datetimepicker({
                  format: 'LT',
                    locale : 'de'
                });
            $('#datetimepicker5').datetimepicker({
                format: 'L',
                locale : 'de'
            });
        })




    </script>
</head>

<body>
<div th:replace="/../fragments/adminHeader ::navbar" name="header"></div>
<div class="container" style="margin-top: 10%">

    <table id="infotable" class=" table table-bordered table-striped table-light" style="margin-bottom: 6%;margin-top: 75px">
        <thead>
        <tr>
            <th>Zuletzt bearbeite am</th>
            <th>Auftraggeber</th>
            <th>Kunde</th>
            <th>Standort</th>
            <th>Monat</th>
            <th>Jahr</th>
            <th>Flächen-nr</th>
            <th>Flächenbetreuung</th>
        </tr>
        </thead>
        <tbody>
            <tr>
                <td ></td>
                <td id="rechnungskunde">test</td>
                <td id="leistungskunde">test</td>
                <td id="ort">test</td>
                <td id="monat"></td>
                <td id="jahr"></td>
                <td id="fläche"></td>
                <td></td>
            </tr>
        </tbody>
    </table>
<table id="datatable" class="table table-striped table-hover" style="margin-top: 200px">
    <thead>

    <tr>
        <td align="left"><a href='javascript:prevMonth()'><i class="fa fa-chevron-left" style="margin: 0px 10px 0px;"></i></a></td>
        <td colspan=3 class='calendar_head_month' id='calendar_month'>
            </td>
        <td><a href='javascript:today()' >Aktueller Monat</a></td>
        <td colspan=4 class='calendar_head_month' id='calendar_month2'>
        </td>
        <td align="right" ><a href='javascript:nextMonth()'><i class="fa fa-chevron-right" style="margin: 0px 10px 0px;"></i></a></td>
    </tr>
    <tr>
        <th scope="col">Datum</th>
        <th scope="col">Wochentag</th>
        <th scope="col">Einsatzkraft</th>
        <th scope="col">Beginn (Uhrzeit)</th>
        <th scope="col">Ende (Uhrzeit)</th>
        <th scope="col">Pause(in Std)</th>
        <th scope="col">Arbeitszeit</th>
        <th scope="col">Bemerkung</th>
        <th scope="col">Status</th>
        <th scope="col"></th>
    </tr>
    </thead>
    <tbody>

    </tbody>
</table>
</div>
<script>
 /*   var button = "<button class=\"btn \" type=\"button\" data-toggle=\"modal\" data-target=\"#myModal\"><i class='fa fa-plus'></i></button>\n" +
        "<div role=\"dialog\" tabindex=\"-1\" class=\"modal fade\" id=\"myModal\">\n" +
        "    <div class=\"modal-dialog\" role=\"document\">\n" +
        "        <div class=\"modal-content\">\n" +
        "            <div class=\"modal-header\">\n" +
        "                <h4 class=\"modal-title\">Besetzung hinzufügen</h4>\n" +
        "                <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Schließen\">\n" +
        "                    <span aria-hidden=\"true\">×</span>\n" +
        "                </button>\n" +
        "            </div>\n" +
        "           <form method='POST' action='/admin/hinzufuegen/besetzung'>\n"+
        "            <div class=\"modal-body\">\n" +
        "                    <label>Flächen-ID</label>\n" +
        "                    <input class=\"form-control\" name='fläche' type=\"text\">\n" +
        "                    <label>Einsatzkraft ID</label>\n" +
        "                    <input class=\"form-control\" name='einsatzkraft' type=\"text\">\n" +
        "                    <label>Projektvertrag Rechnungskunde-ID</label>\n" +
        "                    <input class=\"form-control\" name='projektvertragRechnungskunde'  type=\"text\">\n" +
        "                    <label>Datum</label>\n" +
        "                    <input type=\"text\" class=\"form-control\">\n" +
        "                    <label>LK-Ansprechpartner</label>\n" +
        "                    <input class=\"form-control\"  type=\"text\">\n" +
        "                    <label>Start</label>\n" +
        '                    <div class=\'input-group date\' id=\'datetimepicker6\'>'+
        '                        <input type=\'text\' class="form-control" />'+
        '                        <span class="input-group-addon">'+
        '                     <span class="glyphicon glyphicon-calendar"></span>'+
        '                     </span>'+
        '                    </div>'+
        "                    <label>End</label>\n" +
        '                    <div class=\'input-group date\' id=\'datetimepicker7\'>'+
        '                        <input type=\'text\' class="form-control" />'+
        '                        <span class="input-group-addon">'+
        '                     <span class="glyphicon glyphicon-calendar"></span>'+
        '                     </span>'+
        '                    </div>'+
        '                </form>' +
    "            </div>\n" +
        "            <div class=\"modal-footer\"><button class=\"btn btn-light\" type=\"button\" data-dismiss=\"modal\">Schließen</button><button class=\"btn btn-primary\" type=\"submit\">Speichern</button></div>\n" +
        "           </form>\n" +
        "        </div>\n" +
        "    </div>\n" +
        "</div>" */
 var days = [];
    var events = [];
    var dates = [];
    var currentDate = new Date();
    var currentMonth = currentDate.getMonth();
    var currentYeahr = currentDate.getFullYear();
    var flaechenID;
    datatable = document.getElementById("datatable");
    getEvents();
    initalize();
    var url_string = window.location.href;
    var url = new URL(url_string);
    var c = url.searchParams.get("c");
    console.log(c);
    function initalize() {
        console.log(currentMonth+""+ currentYeahr);
        dates = [];
        var date = new Date(currentYeahr,currentMonth,1);
        var i =0;
        while (date.getMonth() === currentMonth) {
            dates.push(new Date(date));
            var tag = date.getDate() +"."+(date.getMonth()+1)+"."+date.getFullYear();
            var btn = creatButton(tag,i);
            i++;
            var alles = [btn,"","","","","","","",getDayOfWeek(date),tag];
            days.push(alles);
            date.setDate(date.getDate() + 1);
        }
        console.log(events);
        datatable = document.getElementById("datatable");
        loadCalender();
    }

    function today(){
        clearCalender();
        var today = new Date();
        currentMonth = today.getMonth();
        currentYeahr = today.getFullYear();
        var date = new Date(currentYeahr,currentMonth,1);
        var i = 0;
        while (date.getMonth() === currentMonth) {
            dates.push(new Date(date));
            var tag = date.getDate() +"."+(currentMonth+1)+"."+date.getFullYear();
            var btn = creatButton(tag,i);
            i++;
            var alles = [btn,"","","","","","","",getDayOfWeek(date),tag];
            days.push(alles);
            date.setDate(date.getDate() + 1);
        }
        datatable = document.getElementById("datatable");
        loadCalender();
    }

    function prevMonth(){
        getEvents();

        clearCalender()
        if(currentMonth-1<0){
            currentMonth = 11;
            currentYeahr = currentYeahr-1;
        } else {
            currentMonth = currentMonth-1;
        }
        var date = new Date(currentYeahr,currentMonth,1);
        var i = 0;
        while (date.getMonth() === currentMonth) {
            dates.push(new Date(date));
            var tag = date.getDate() +"."+(currentMonth+1)+"."+date.getFullYear();
            var btn = creatButton(tag,i);
            i++;
            var alles = [btn,"","","","","","","",getDayOfWeek(date),tag];
            days.push(alles);
            date.setDate(date.getDate() + 1);
        }
        datatable = document.getElementById("datatable");
        loadCalender();
    }
    function nextMonth(){
        getEvents();

        clearCalender()
        if(currentMonth+2>12){
            currentMonth = 0;
            currentYeahr = currentYeahr+1;
        } else {
            currentMonth = currentMonth+1;
        }
        var date = new Date(currentYeahr,currentMonth,1);
        var i = 0;
        while (date.getMonth() === currentMonth) {
            var tag = date.getDate() +"."+(currentMonth+1)+"."+date.getFullYear();
            var btn = creatButton(tag,i);
            i++;
            var alles = [btn,"","","","","","","",getDayOfWeek(date),tag];
            days.push(alles);
            dates.push(new Date(date));
            date.setDate(date.getDate() + 1);

        }
        datatable = document.getElementById("datatable");
        console.log(dates);
        loadCalender();
    }

    function clearCalender(){
        days = [];
        dates = [];
        var myTable = document.getElementById("datatable");
        var rowCount = myTable.rows.length;
        for (var x=rowCount-1;x>1; x--) {
            myTable.deleteRow(x);
        }
    }

    function getEvents(){
        var request = new XMLHttpRequest();
        request.open('GET', '/admin/kalender/events?yeahr='+currentYeahr+"&month="+currentMonth, true);
        request.onload = function () {
            if (request.status >= 200 && request.status < 400) {
                events = [];
                events = JSON.parse(this.response);
                console.log(events);
            } else {
                console.log('error');
            }
        }
        request.send();

    }

    //Schreibt die Tage/Monate/Jahre und andere Daten in die Tabelle
    function loadCalender(){
        insertEvents();
        getRechnungskundeInformation();
        var monat = document.getElementById("monat");
        monat.innerHTML = getNameOfMonth(currentMonth);
        var jahr = document.getElementById("jahr");
        jahr.innerHTML = currentYeahr;
        for(var i = 0; i < days.length; i++)
        {
            // create a new row
            var newRow = datatable.insertRow(datatable.length);
            for(var j = 0; j < days[i].length; j++)
            {
                // create a new cell
                var cell = newRow.insertCell(0);
                // add value to the cell
                cell.innerHTML = days[i][j];
                if(days[i][8]==="Sonntag"||days[i][8]==="Samstag"){
                    $(cell).addClass("table-active");
                }
            }
        }

    }

    //Schreibt in das Day Array die Events für eine Flaeche
    function insertEvents(){
        for(var i = 0; i<events.length;i++) {
            for(var j = 0;j<dates.length;j++) {
                var acevent = events[i].start;
                var acdate = acevent.substr(0, acevent.length-5);
                var newdate = new Date(acdate);
                if(sameDate(newdate,dates[j])) {
                    if(days[j][4]!== ""){
                        days.splice(j,0,days[j])
                        replace(i,j+1,events[i].einsatzkraft,events[i])
                    } else {
                        replace(i,j,events[i].einsatzkraft,events[i]);

                    }
                }
            }
        }
    }
    //tauscht zwei daten miteinander aus
    function replace(stelledaten,stellearray,einsatzkraft,besetzung){
        events[stelledaten]
        days[stellearray]
        var array = [];
        for(var i = 0;i<days[stellearray].length;i++){
            array.push(days[stellearray][i]);
        }
        var acevent = events[stelledaten].start;
        var acdate = acevent.substr(0, acevent.length-5);
        var newdate = new Date(acdate);
        var acevent2 = events[stelledaten].end;
        var acdate2 = acevent2.substr(0, acevent.length-5);
        var newdate2 = new Date(acdate2);
        array[7] = einsatzkraft.vorname + " " + einsatzkraft.name;
        array[4] = "0.5";
        array[5] = newdate.getHours();
        array[6] = newdate2.getHours();
        var x = parseFloat(array[4]);
        console.log(x);
        array[3] =  newdate.getHours()-newdate2.getHours()-x;
        if(besetzung.anfrageVersendung!=null&&besetzung.anfrageVersendung=="bestätigt") {
            array[1] = " <a href=\"\" class=\"label label-success\">Bestätigt</a> ";
        } else {
            array[1] = " <a href=\"\" class=\"label label-danger\">Offen</a> ";
        }
        days[stellearray] = array;
    }
    //gibt die RechnungskundenInformation an die Tabelle aus
    function getRechnungskundeInformation() {
        var request = new XMLHttpRequest();
        request.open('GET', '/admin/kalender/fläche', true);
        request.onload = function () {
            if (request.status >= 200 && request.status < 400) {
                var flächeData = JSON.parse(this.response);
                var fläche = document.getElementById("fläche");
                flaechenID = flächeData.id;
                fläche.innerHTML = flächeData.id;
                var rechnungsKunde = document.getElementById("rechnungskunde")
                rechnungsKunde.innerHTML = flächeData.rechnungskundeDifferenzierung.rechnungskunde.name;
                var leistungskunde = document.getElementById("leistungskunde")
                leistungskunde.innerHTML = flächeData.leistungskunde.name;
                var ort = document.getElementById("ort");
                ort.innerHTML = flächeData.leistungskunde.ort;
            } else {
                console.log('error');
            }
        }
        request.send();
    }

    function creatButton(date,number){
        var myButton =  "<button class=\"btn\" type=\"button\" data-toggle=\"modal\" style='background:none;border:0' data-target='#myModal"+number+"'><i class='fa fa-plus' style='color:green'></i></button>\n" +
            "<button class=\"btn\" type=\"button\"  style='background:none;border:0'><i class='fa fa-pencil'></i></button>\n" +
            "<div role=\"dialog\" tabindex=\"-1\" class=\"modal fade\" id='myModal"+number+"'>\n" +
            "    <div class=\"modal-dialog\" role=\"document\">\n" +
            "        <div class=\"modal-content\">\n" +
            "            <div class=\"modal-header\">\n" +
            "                <h4 class=\"modal-title\">Besetzung hinzufügen</h4>\n" +
            "                <button type=\"button\" class=\"close\" data-dismiss=\"modal\" aria-label=\"Schließen\">\n" +
            "                    <span aria-hidden=\"true\">×</span>\n" +
            "                </button>\n" +
            "            </div>\n" +
            "           <form method='POST' action='/admin/hinzufuegen/besetzung'>\n"+
            "            <div class=\"modal-body\">\n" +
            "                    <label>Flächen-ID</label>\n" +
            "                    <input class=\"form-control\" name='fläche' value='"+flaechenID+"' type=\"text\">\n" +
            "                    <label>Einsatzkraft ID</label>\n" +
            "                    <input class=\"form-control\" name='einsatzkraft' type=\"text\">\n" +
            "                    <label>Projektvertrag Rechnungskunde-ID</label>\n" +
            "                    <input class=\"form-control\" name='projektvertragRechnungskunde'  type=\"text\">\n" +
            "                    <label>Datum</label>\n" +
            '                    <div class=\'input-group date\' id=\'datetimepicker5\'>'+
            '                        <input type=\'text\' class="form-control" />'+
            '                        <span class="input-group-addon">'+
            '                     <span class="glyphicon glyphicon-calendar"></span>'+
            '                     </span>'+
            '                    </div>'+
            "                    <label>LK-Ansprechpartner</label>\n" +
            "                    <input class=\"form-control\"  type=\"text\">\n" +
            "                    <label>Start</label>\n" +
            '                    <div class=\'input-group date\' id=\'datetimepicker6\'>'+
            '                        <input type=\'text\' class="form-control" />'+
            '                        <span class="input-group-addon">'+
            '                     <span class="glyphicon glyphicon-calendar"></span>'+
            '                     </span>'+
            '                    </div>'+
            "                    <label>End</label>\n" +
            '                    <div class=\'input-group date\' id=\'datetimepicker7\'>'+
            '                        <input type=\'text\' class="form-control" />'+
            '                        <span class="input-group-addon">'+
            '                     <span class="glyphicon glyphicon-calendar"></span>'+
            '                     </span>'+
            '                    </div>'+
            '                </form>' +
            "            </div>\n" +
            "            <div class=\"modal-footer\"><button class=\"btn btn-light\" type=\"button\" data-dismiss=\"modal\">Schließen</button><button class=\"btn btn-primary\" type=\"submit\">Speichern</button></div>\n" +
            "           </form>\n" +
            "        </div>\n" +
            "    </div>\n" +
            "</div>"
            return myButton;
    }
    //Schreibt Zahlen in Monate um
    function getNameOfMonth(date){
        var months    = ['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
        return months[date];
    }

    //Schreibt Zahlen in Wochentage um
    function getDayOfWeek(date) {
        var dayOfWeek = new Date(date).getDay();
        return isNaN(dayOfWeek) ? null : ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'][dayOfWeek];
    }

    //Überprüft ob zwei Daten gleich sind
    function sameDate(date1, date2) {
        return date1.getDate() == date2.getDate() &&
            date1.getMonth() == date2.getMonth() &&
            date1.getFullYear() == date2.getFullYear();
    }

    function checkStatus(einsatzkraft){
        if(einsatzkraft.anfrageVersendung!=null){
        } else {

        }
    }



</script>
</body>
</html>